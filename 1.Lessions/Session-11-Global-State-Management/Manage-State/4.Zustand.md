# Quáº£n lÃ½ State Gobal vá»›i Zustand

## 1. Giá»›i thiá»‡u

**Zustand** (phÃ¡t Ã¢m lÃ  /ËˆtsuËÊƒtant/', tiáº¿ng Äá»©c cÃ³ nghÄ©a lÃ  "tráº¡ng thÃ¡i") lÃ  má»™t thÆ° viá»‡n quáº£n lÃ½ tráº¡ng thÃ¡i (state management) cho cÃ¡c á»©ng dá»¥ng JavaScript, Ä‘áº·c biá»‡t phá»• biáº¿n trong há»‡ sinh thÃ¡i React. NÃ³ ra Ä‘á»i vá»›i triáº¿t lÃ½ tá»‘i giáº£n, linh hoáº¡t vÃ  Ã­t khuÃ´n máº«u (boilerplate), giÃºp cÃ¡c nhÃ  phÃ¡t triá»ƒn quáº£n lÃ½ state cá»§a á»©ng dá»¥ng má»™t cÃ¡ch dá»… dÃ ng vÃ  hiá»‡u quáº£.

HÃ£y tÆ°á»Ÿng tÆ°á»£ng Zustand nhÆ° má»™t "kho chá»©a" toÃ n cá»¥c (global store) cho á»©ng dá»¥ng cá»§a báº¡n. Thay vÃ¬ pháº£i truyá»n dá»¯ liá»‡u (props) qua nhiá»u táº§ng component (má»™t váº¥n Ä‘á» gá»i lÃ  "prop drilling"), báº¡n cÃ³ thá»ƒ Ä‘áº·t dá»¯ liá»‡u Ä‘Ã³ vÃ o kho cá»§a Zustand. Sau Ä‘Ã³, báº¥t ká»³ component nÃ o cáº§n dá»¯ liá»‡u Ä‘Ã³ Ä‘á»u cÃ³ thá»ƒ káº¿t ná»‘i trá»±c tiáº¿p vÃ o kho Ä‘á»ƒ láº¥y hoáº·c cáº­p nháº­t nÃ³.

Zustand Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn cÃ¡c React Hooks, giÃºp nÃ³ tÃ­ch há»£p má»™t cÃ¡ch tá»± nhiÃªn vÃ  liá»n máº¡ch vá»›i cÃ¡c á»©ng dá»¥ng React hiá»‡n Ä‘áº¡i.

### 1.2. **CÃ¡c TÃ­nh NÄƒng Ná»•i Báº­t cá»§a Zustand**

Zustand Ä‘Æ°á»£c yÃªu thÃ­ch nhá» vÃ o nhá»¯ng Ä‘áº·c Ä‘iá»ƒm máº¡nh máº½ vÃ  Ä‘Æ¡n giáº£n sau:

1. **Cá»±c ká»³ nhá» gá»n vÃ  nhanh chÃ³ng:**
    * **KÃ­ch thÆ°á»›c nhá»:** ThÆ° viá»‡n nÃ y cÃ³ kÃ­ch thÆ°á»›c chá»‰ khoáº£ng 1KB (gzipped). Viá»‡c thÃªm nÃ³ vÃ o dá»± Ã¡n gáº§n nhÆ° khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n thá»i gian táº£i trang cá»§a ngÆ°á»i dÃ¹ng.
    * **Hiá»‡u nÄƒng cao:** Zustand chá»‰ cáº­p nháº­t (re-render) nhá»¯ng component cÃ³ sá»­ dá»¥ng Ä‘áº¿n pháº§n state bá»‹ thay Ä‘á»•i, nhá» vÃ o cÆ¡ cháº¿ selector dá»±a trÃªn hooks. Äiá»u nÃ y giÃºp trÃ¡nh cÃ¡c láº§n re-render khÃ´ng cáº§n thiáº¿t vÃ  tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t á»©ng dá»¥ng.

2. **Ráº¥t Ã­t Boilerplate (MÃ£ khuÃ´n máº«u):**
    * So vá»›i cÃ¡c thÆ° viá»‡n khÃ¡c nhÆ° Redux, viá»‡c thiáº¿t láº­p má»™t store vá»›i Zustand Ä‘Æ¡n giáº£n hÆ¡n ráº¥t nhiá»u. Báº¡n khÃ´ng cáº§n pháº£i Ä‘á»‹nh nghÄ©a `actions`, `reducers`, `dispatchers` hay bá»c á»©ng dá»¥ng trong má»™t `<Provider>`. Báº¡n chá»‰ cáº§n má»™t hÃ m `create` lÃ  Ä‘á»§.

    * **VÃ­ dá»¥ so sÃ¡nh:**
        * **Redux (cÆ¡ báº£n):** Cáº§n thiáº¿t láº­p store, reducer, action types, action creators.
        * **Zustand:**

            ```javascript
            import { create } from 'zustand';

            const useStore = create(set => ({
              bears: 0,
              increasePopulation: () => set(state => ({ bears: state.bears + 1 })),
            }));
            ```

            Chá»‰ vá»›i vÃ i dÃ²ng code, báº¡n Ä‘Ã£ cÃ³ má»™t store hoÃ n chá»‰nh vá»›i state vÃ  action.

3. **KhÃ´ng phá»¥ thuá»™c vÃ o React Context:**
    * KhÃ¡c vá»›i nhiá»u giáº£i phÃ¡p quáº£n lÃ½ state khÃ¡c, Zustand khÃ´ng sá»­ dá»¥ng React Context á»Ÿ phÃ­a sau. Äiá»u nÃ y giÃºp trÃ¡nh Ä‘Æ°á»£c cÃ¡c váº¥n Ä‘á» vá» hiá»‡u nÄƒng khi state cáº­p nháº­t thÆ°á»ng xuyÃªn trong má»™t cÃ¢y component lá»›n (context re-render issue). Dá»¯ liá»‡u Ä‘Æ°á»£c truy cáº­p trá»±c tiáº¿p tá»« store.

4. **TÃ­ch há»£p Middleware má»™t cÃ¡ch linh hoáº¡t:**
    * Zustand há»— trá»£ cÃ¡c middleware máº¡nh máº½ Ä‘á»ƒ má»Ÿ rá»™ng chá»©c nÄƒng. Má»™t sá»‘ middleware phá»• biáº¿n cÃ³ sáºµn bao gá»“m:
        * `devtools`: Káº¿t ná»‘i store cá»§a báº¡n vá»›i Redux DevTools Extension trÃªn trÃ¬nh duyá»‡t, giÃºp viá»‡c debug trá»Ÿ nÃªn cá»±c ká»³ trá»±c quan.
        * `persist`: Tá»± Ä‘á»™ng lÆ°u state vÃ o `localStorage` (hoáº·c `sessionStorage`, `AsyncStorage`) vÃ  khÃ´i phá»¥c láº¡i khi ngÆ°á»i dÃ¹ng táº£i láº¡i trang.
        * `immer`: Cho phÃ©p báº¡n viáº¿t logic cáº­p nháº­t state theo kiá»ƒu "Ä‘á»™t biáº¿n" (mutative) nhÆ°ng váº«n Ä‘áº£m báº£o tÃ­nh báº¥t biáº¿n (immutability) á»Ÿ phÃ­a sau.

5. **Sá»­ dá»¥ng Ä‘Æ°á»£c bÃªn ngoÃ i React:**
    * Máº·c dÃ¹ ráº¥t phá»• biáº¿n vá»›i React, lÃµi cá»§a Zustand lÃ  vanilla JavaScript. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng nÃ³ Ä‘á»ƒ quáº£n lÃ½ state trong báº¥t ká»³ á»©ng dá»¥ng JavaScript nÃ o, khÃ´ng chá»‰ riÃªng React.

### 1.2. **Khi nÃ o thÃ¬ sá»­ dá»¥ng Zustand**

1. Quáº£n lÃ½ xÃ¡c thá»±c tráº¡ng thÃ¡i ngÆ°á»i dÃ¹ng
1. Quáº£n lÃ½ giá» hÃ ng
1. Quáº£n lÃ½ Tráº¡ng ThÃ¡i Form Phá»©c Táº¡p
1. Tráº¡ng ThÃ¡i Cáº¥u hÃ¬nh CÃ i Äáº·t cá»§a á»©ng dá»¥ng
1. Caching Dá»¯ liá»‡u API hoáº·c Dá»¯ liá»‡u Äá»™ng

## 3. **CÃ¡ch CÃ i Äáº·t Zustand**

Viá»‡c cÃ i Ä‘áº·t Zustand ráº¥t Ä‘Æ¡n giáº£n. Báº¡n chá»‰ cáº§n cháº¡y má»™t lá»‡nh duy nháº¥t trong terminal táº¡i thÆ° má»¥c gá»‘c cá»§a dá»± Ã¡n.

**Sá»­ dá»¥ng npm:**

```bash
npm install zustand
```

**Sá»­ dá»¥ng yarn:**

```bash
yarn add zustand
```

**Sá»­ dá»¥ng pnpm:**

```bash
pnpm add zustand
```

Sau khi cÃ i Ä‘áº·t xong, báº¡n cÃ³ thá»ƒ báº¯t Ä‘áº§u táº¡o store Ä‘áº§u tiÃªn cá»§a mÃ¬nh báº±ng cÃ¡ch import hÃ m `create` tá»« thÆ° viá»‡n:

```javascript
import { create } from 'zustand';
```

VÃ  báº¡n Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ xÃ¢y dá»±ng cÃ¡c kho chá»©a state máº¡nh máº½ vÃ  hiá»‡u quáº£ cho á»©ng dá»¥ng cá»§a mÃ¬nh!

## 4. VÃ­ dá»¥ vá» cÃ¡ch sá»­ dá»¥ng cÆ¡ báº£n

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ Ä‘áº§y Ä‘á»§ vÃ  chi tiáº¿t tá»« cáº¥u trÃºc thÆ° má»¥c Ä‘áº¿n code vÃ  giáº£i thÃ­ch cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a á»©ng dá»¥ng tÄƒng giáº£m sá»‘ Ä‘áº¿m (counter) vá»›i Zustand.

---

ChÃºng ta sáº½ xÃ¢y dá»±ng má»™t á»©ng dá»¥ng React siÃªu Ä‘Æ¡n giáº£n cÃ³:

* Má»™t dÃ²ng hiá»ƒn thá»‹ sá»‘ Ä‘áº¿m hiá»‡n táº¡i.
* CÃ¡c nÃºt báº¥m Ä‘á»ƒ "TÄƒng", "Giáº£m" vÃ  "Reset" sá»‘ Ä‘áº¿m Ä‘Ã³.
* Hai component riÃªng biá»‡t sáº½ cÃ¹ng truy cáº­p vÃ o má»™t state chung mÃ  khÃ´ng cáº§n truyá»n props.

### **4.1. Cáº¥u trÃºc ThÆ° má»¥c Ä‘á» xuáº¥t**

Äá»ƒ giá»¯ cho dá»± Ã¡n gá»n gÃ ng vÃ  dá»… báº£o trÃ¬, báº¡n nÃªn tÃ¡ch riÃªng logic cá»§a store ra má»™t thÆ° má»¥c riÃªng. ÄÃ¢y lÃ  cáº¥u trÃºc phá»• biáº¿n vÃ  hiá»‡u quáº£:

```
/my-react-app
â”œâ”€â”€ node_modules/
â”œâ”€â”€ public/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/                 <-- ThÆ° má»¥c chá»©a cÃ¡c component UI
â”‚   â”‚   â”œâ”€â”€ CounterDisplay.jsx
â”‚   â”‚   â””â”€â”€ CounterControls.jsx
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/                     <-- ThÆ° má»¥c chá»©a cÃ¡c store cá»§a Zustand
â”‚   â”‚   â””â”€â”€ counterStore.js         <-- File Ä‘á»‹nh nghÄ©a store Ä‘áº¿m sá»‘
â”‚   â”‚
â”‚   â”œâ”€â”€ App.jsx                     <-- Component chÃ­nh cá»§a á»©ng dá»¥ng
â”‚   â”œâ”€â”€ main.jsx (hoáº·c index.js)    <-- File gá»‘c cá»§a React
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ package.json
```

### **4.2. Viáº¿t mÃ£ cho Store (`stores/counterStore.js`)**

ÄÃ¢y lÃ  trÃ¡i tim cá»§a viá»‡c quáº£n lÃ½ state. ChÃºng ta sáº½ Ä‘á»‹nh nghÄ©a state vÃ  cÃ¡c hÃ nh Ä‘á»™ng (actions) Ä‘á»ƒ thay Ä‘á»•i state Ä‘Ã³.

```javascript
// src/stores/counterStore.js

import { create } from 'zustand';

// create() lÃ  hÃ m chÃ­nh Ä‘á»ƒ táº¡o má»™t store
const useCounterStore = create((set) => ({
  /**
   * STATE
   * ÄÃ¢y lÃ  dá»¯ liá»‡u mÃ  báº¡n muá»‘n lÆ°u trá»¯.
   */
  count: 0,

  /**
   * ACTIONS
   * ÄÃ¢y lÃ  cÃ¡c hÃ m dÃ¹ng Ä‘á»ƒ cáº­p nháº­t state.
   * `set` lÃ  hÃ m Ä‘áº·c biá»‡t do Zustand cung cáº¥p Ä‘á»ƒ cáº­p nháº­t state má»™t cÃ¡ch an toÃ n.
   */
  
  // HÃ nh Ä‘á»™ng tÄƒng count lÃªn 1
  increment: () => {
    set((state) => ({ count: state.count + 1 }));
  },

  // HÃ nh Ä‘á»™ng giáº£m count Ä‘i 1
  decrement: () => {
    set((state) => ({ count: state.count - 1 }));
  },

  // HÃ nh Ä‘á»™ng reset count vá» 0
  reset: () => {
    set({ count: 0 });
  },

  // HÃ nh Ä‘á»™ng tÄƒng má»™t lÆ°á»£ng tÃ¹y Ã½
  increaseBy: (amount) => {
    set((state) => ({ count: state.count + amount }));
  }
}));

export default useCounterStore;
```

**Giáº£i thÃ­ch:**

* `create( (set) => ({...}) )`: ChÃºng ta táº¡o store báº±ng hÃ m `create`. HÃ m nÃ y nháº­n vÃ o má»™t hÃ m khá»Ÿi táº¡o.
* `set`: LÃ  má»™t hÃ m dÃ¹ng Ä‘á»ƒ cáº­p nháº­t state. Khi báº¡n gá»i `set`, Zustand sáº½ Ä‘áº£m báº£o chá»‰ nhá»¯ng component nÃ o Ä‘ang "láº¯ng nghe" sá»± thay Ä‘á»•i Ä‘Ã³ má»›i Ä‘Æ°á»£c render láº¡i.
* `(state) => ({ count: state.count + 1 })`: ÄÃ¢y Ä‘Æ°á»£c gá»i lÃ  "functional update". CÃ¡ch viáº¿t nÃ y Ä‘áº£m báº£o báº¡n luÃ´n lÃ m viá»‡c vá»›i giÃ¡ trá»‹ state má»›i nháº¥t, trÃ¡nh Ä‘Æ°á»£c cÃ¡c lá»—i tiá»m áº©n khi nhiá»u cáº­p nháº­t xáº£y ra gáº§n nhau.

### **4.3. CÃ¡ch sá»­ dá»¥ng Store trong cÃ¡c Component**

BÃ¢y giá» chÃºng ta sáº½ táº¡o 2 component vÃ  cho chÃºng sá»­ dá»¥ng `useCounterStore`.

#### **Component hiá»ƒn thá»‹ sá»‘ Ä‘áº¿m (`components/CounterDisplay.jsx`)**

Component nÃ y chá»‰ cÃ³ má»™t nhiá»‡m vá»¥: láº¥y `count` tá»« store vÃ  hiá»ƒn thá»‹ nÃ³.

```jsx
// src/components/CounterDisplay.jsx

import React from 'react';
import useCounterStore from '../stores/counterStore';

function CounterDisplay() {
  // Sá»­ dá»¥ng hook cá»§a store vÃ  má»™t "selector" Ä‘á»ƒ láº¥y Ä‘Ãºng pháº§n state cáº§n thiáº¿t.
  // Component nÃ y sáº½ chá»‰ re-render khi `state.count` thay Ä‘á»•i.
  const count = useCounterStore((state) => state.count);

  return (
    <div style={{ marginBottom: '20px' }}>
      <h1>{count}</h1>
    </div>
  );
}

export default CounterDisplay;
```

**Äiá»ƒm quan trá»ng:** `useCounterStore((state) => state.count)` Ä‘Æ°á»£c gá»i lÃ  má»™t **selector**. NÃ³ chá»‰ láº¥y ra giÃ¡ trá»‹ `count` tá»« store. Nhá» váº­y, component nÃ y sáº½ khÃ´ng bá»‹ render láº¡i náº¿u má»™t pháº§n state khÃ¡c trong store thay Ä‘á»•i (vÃ­ dá»¥: `state.user` nÃ o Ä‘Ã³). ÄÃ¢y lÃ  cÃ¡ch tá»‘i Æ°u hiá»‡u nÄƒng cá»‘t lÃµi cá»§a Zustand.

#### **Component chá»©a cÃ¡c nÃºt Ä‘iá»u khiá»ƒn (`components/CounterControls.jsx`)**

Component nÃ y sáº½ láº¥y cÃ¡c hÃ nh Ä‘á»™ng (`actions`) tá»« store Ä‘á»ƒ gá»i chÃºng khi ngÆ°á»i dÃ¹ng nháº¥n nÃºt.

```jsx
// src/components/CounterControls.jsx

import React from 'react';
import useCounterStore from '../stores/counterStore';

function CounterControls() {
  // Láº¥y cÃ¡c action tá»« store
  const { increment, decrement, reset, increaseBy } = useCounterStore();

  return (
    <div>
      <button onClick={increment}>TÄƒng 1</button>
      <button onClick={decrement} style={{ margin: '0 10px' }}>Giáº£m 1</button>
      <button onClick={reset}>Reset</button>
      <button onClick={() => increaseBy(5)} style={{ marginLeft: '10px' }}>TÄƒng 5</button>
    </div>
  );
}

export default CounterControls;

```

**Giáº£i thÃ­ch:**

* á» Ä‘Ã¢y, chÃºng ta láº¥y ra cÃ¡c hÃ m `increment`, `decrement`, `reset`... tá»« store.
* Sau Ä‘Ã³, chÃºng ta gÃ¡n chÃºng trá»±c tiáº¿p vÃ o sá»± kiá»‡n `onClick` cá»§a cÃ¡c nÃºt báº¥m. Khi má»™t nÃºt Ä‘Æ°á»£c nháº¥n, hÃ m tÆ°Æ¡ng á»©ng trong store sáº½ Ä‘Æ°á»£c gá»i vÃ  state `count` sáº½ Ä‘Æ°á»£c cáº­p nháº­t.

### **4.4. Káº¿t há»£p táº¥t cáº£ trong `App.jsx`**

Cuá»‘i cÃ¹ng, chÃºng ta chá»‰ cáº§n Ä‘áº·t cÃ¡c component nÃ y vÃ o `App.jsx`.

```jsx
// src/App.jsx

import React from 'react';
import CounterDisplay from './components/CounterDisplay';
import CounterControls from './components/CounterControls';
import './App.css'; // File CSS Ä‘á»ƒ cÄƒn giá»¯a cho Ä‘áº¹p

function App() {
  return (
    <div className="App">
      <h2>VÃ­ dá»¥ cÆ¡ báº£n vá» Zustand</h2>
      <p>Hai component dÆ°á»›i Ä‘Ã¢y khÃ´ng trao Ä‘á»•i props, chÃºng cÃ¹ng láº¥y dá»¯ liá»‡u tá»« má»™t store chung.</p>
      
      {/* Component chá»‰ Ä‘á»ƒ hiá»ƒn thá»‹ */}
      <CounterDisplay />
      
      {/* Component chá»‰ Ä‘á»ƒ Ä‘iá»u khiá»ƒn */}
      <CounterControls />
    </div>
  );
}

export default App;
```

## 5. Tá»‘i Æ°u Selector trong Zustand

### Selector lÃ  gÃ¬?

`Selector` vá» cÆ¡ báº£n lÃ  má»™t `hÃ m` nháº­n vÃ o toÃ n bá»™ state cá»§a store vÃ  tráº£ vá» chá»‰ nhá»¯ng pháº§n dá»¯ liá»‡u mÃ  component cá»§a báº¡n thá»±c sá»± cáº§n.

### Ãp dá»¥ng Selector trong vÃ­ dá»¥ `CounterControls` cá»§a báº¡n

Thay vÃ¬ báº¡n code nhÆ° tháº¿ nÃ y

```js
//Láº¥y cÃ¡c action tá»« store vá»›i cÃº phÃ¡p destructuring
  const { increment, decrement, reset, increaseBy } = useCounterStore();
```

Tá»‘i Æ°u láº¡i vá»›i selector nhÆ° sau:

âœ… CÃ¡ch 1: TÃ¡ch tá»«ng selector

```js
const increment = useCounterStore((state) => state.increment);
const decrement = useCounterStore((state) => state.decrement);
const reset = useCounterStore((state) => state.reset);
const increaseBy = useCounterStore((state) => state.increaseBy);

```

âœ… CÃ¡ch 2: DÃ¹ng shallow comparison Ä‘á»ƒ destructuring nhiá»u field:

```js
import { shallow } from 'zustand/shallow'; // Import shallow tá»« zustand/shallow

// --- CÃCH CUSTOM Báº°NG SELECTOR ---
  // Láº¥y cÃ¡c action tá»« store sá»­ dá»¥ng selector vÃ  shallow comparison
  const { increment, decrement, reset, increaseBy } = useCounterStore(
    (state) => ({
      increment: state.increment,
      decrement: state.decrement,
      reset: state.reset,
      increaseBy: state.increaseBy,
    }),
    shallow // <-- Sá»­ dá»¥ng shallow comparison á»Ÿ Ä‘Ã¢y
  );

```

Xem thÃªm: <https://zustand.docs.pmnd.rs/apis/shallow>

**Giáº£i thÃ­ch cÃ¡c thay Ä‘á»•i**:

1. **Selector Function:**

    ```javascript
    (state) => ({
      increment: state.increment,
      decrement: state.decrement,
      reset: state.reset,
      increaseBy: state.increaseBy,
    })
    ```

    ÄÃ¢y lÃ  hÃ m selector cá»§a báº¡n. NÃ³ nháº­n vÃ o toÃ n bá»™ `state` cá»§a store vÃ  tráº£ vá» má»™t **Ä‘á»‘i tÆ°á»£ng má»›i** chá»©a cÃ¡c hÃ m action mÃ  báº¡n muá»‘n.

2. **`shallow` Comparison (Quan trá»ng!):**

    ```javascript
    shallow // <-- ThÃªm tham sá»‘ thá»© hai cho useCounterStore
    ```

    ÄÃ¢y lÃ  pháº§n **quan trá»ng nháº¥t** khi báº¡n tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng má»›i tá»« selector.
    * Khi báº¡n tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng (hoáº·c máº£ng) tá»« selector, trÃªn má»—i láº§n render, JavaScript sáº½ táº¡o ra má»™t Ä‘á»‘i tÆ°á»£ng má»›i (`{ increment: ..., decrement: ..., ... }`).
    * Theo máº·c Ä‘á»‹nh, Zustand (vÃ  React) thá»±c hiá»‡n so sÃ¡nh tham chiáº¿u. Náº¿u báº¡n khÃ´ng sá»­ dá»¥ng `shallow`, Zustand sáº½ tháº¥y ráº±ng báº¡n luÃ´n tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng má»›i (ngay cáº£ khi cÃ¡c thuá»™c tÃ­nh bÃªn trong Ä‘á»‘i tÆ°á»£ng Ä‘Ã³ khÃ´ng thay Ä‘á»•i), vÃ  Ä‘iá»u nÃ y sáº½ gÃ¢y ra **re-render khÃ´ng cáº§n thiáº¿t** trÃªn má»—i láº§n component re-render.
    * `shallow` lÃ  má»™t hÃ m tiá»‡n Ã­ch tá»« Zustand (`zustand/shallow`). NÃ³ thá»±c hiá»‡n **so sÃ¡nh nÃ´ng (shallow comparison)** trÃªn cÃ¡c thuá»™c tÃ­nh cá»§a Ä‘á»‘i tÆ°á»£ng Ä‘Æ°á»£c tráº£ vá». Tá»©c lÃ , nÃ³ sáº½ so sÃ¡nh tá»«ng thuá»™c tÃ­nh (`increment`, `decrement`, v.v.) cá»§a Ä‘á»‘i tÆ°á»£ng cÅ© vÃ  Ä‘á»‘i tÆ°á»£ng má»›i. VÃ¬ cÃ¡c hÃ m action cá»§a báº¡n cÃ³ tham chiáº¿u á»•n Ä‘á»‹nh, `shallow` sáº½ nháº­n ra ráº±ng cÃ¡c thuá»™c tÃ­nh nÃ y khÃ´ng thay Ä‘á»•i, vÃ  do Ä‘Ã³, component sáº½ **khÃ´ng re-render** chá»‰ vÃ¬ báº¡n Ä‘Ã£ táº¡o ra má»™t Ä‘á»‘i tÆ°á»£ng má»›i.

## 6. `set` vÃ  `get` trong Zustand

Trong Zustand, hÃ m `create` mÃ  báº¡n dÃ¹ng Ä‘á»ƒ Ä‘á»‹nh nghÄ©a store nháº­n má»™t callback function. Callback nÃ y cung cáº¥p hai tham sá»‘ quan trá»ng: `set` vÃ  `get`.

```javascript
import { create } from 'zustand';

const useMyStore = create((set, get) => ({
  // ... state vÃ  actions
}));
```

### 6.1. `set` Function

Báº¡n Ä‘Ã£ sá»­ dá»¥ng `set` Ä‘á»ƒ cáº­p nháº­t state trong cÃ¡c actions cá»§a mÃ¬nh.

**Má»¥c Ä‘Ã­ch:** DÃ¹ng Ä‘á»ƒ cáº­p nháº­t state cá»§a store.

**CÃ¡c cÃ¡ch sá»­ dá»¥ng chÃ­nh cá»§a `set`:**

* **Cáº­p nháº­t trá»±c tiáº¿p má»™t pháº§n state (Partial State Update):**
    Báº¡n cÃ³ thá»ƒ truyá»n má»™t object trá»±c tiáº¿p vÃ o `set`. Zustand sáº½ tá»± Ä‘á»™ng merge object nÃ y vá»›i state hiá»‡n táº¡i.

    ```javascript
    reset: () => {
      set({ count: 0 }); // Cáº­p nháº­t trá»±c tiáº¿p count vá» 0
    },
    ```

    CÃ¡ch nÃ y Ä‘Æ¡n giáº£n vÃ  hiá»‡u quáº£ khi giÃ¡ trá»‹ má»›i cá»§a state khÃ´ng phá»¥ thuá»™c vÃ o giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a nÃ³.

* **Cáº­p nháº­t state dá»±a trÃªn state hiá»‡n táº¡i (Function Update):**
    ÄÃ¢y lÃ  cÃ¡ch báº¡n Ä‘Ã£ sá»­ dá»¥ng vÃ  lÃ  cÃ¡ch Ä‘Æ°á»£c khuyáº¿n nghá»‹ khi giÃ¡ trá»‹ má»›i cá»§a state phá»¥ thuá»™c vÃ o giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a nÃ³. Báº¡n truyá»n má»™t hÃ m vÃ o `set`. HÃ m nÃ y nháº­n `state` hiá»‡n táº¡i lÃ m Ä‘á»‘i sá»‘ vÃ  tráº£ vá» object chá»©a pháº§n state muá»‘n cáº­p nháº­t.

    ```javascript
    increment: () => {
      set((state) => ({ count: state.count + 1 })); // count má»›i phá»¥ thuá»™c vÃ o state.count hiá»‡n táº¡i
    },
    increaseBy: (amount) => {
      set((state) => ({ count: state.count + amount })); // count má»›i phá»¥ thuá»™c vÃ o state.count hiá»‡n táº¡i
    }
    ```

    **LÃ½ do nÃªn dÃ¹ng cÃ¡ch nÃ y:**
  * **An toÃ n trong mÃ´i trÆ°á»ng báº¥t Ä‘á»“ng bá»™ (Asynchronous Safety):** Khi cÃ³ nhiá»u cáº­p nháº­t xáº£y ra gáº§n nhÆ° Ä‘á»“ng thá»i hoáº·c trong cÃ¡c tÃ¡c vá»¥ báº¥t Ä‘á»“ng bá»™, viá»‡c sá»­ dá»¥ng hÃ m cáº­p nháº­t Ä‘áº£m báº£o báº¡n luÃ´n lÃ m viá»‡c vá»›i phiÃªn báº£n state má»›i nháº¥t. NÃ³ tÆ°Æ¡ng tá»± nhÆ° viá»‡c sá»­ dá»¥ng `setState` vá»›i má»™t callback trong React Class Components.
  * **TrÃ¡nh Race Conditions:** NgÄƒn cháº·n cÃ¡c lá»—i xáº£y ra khi thá»© tá»± cÃ¡c cáº­p nháº­t khÃ´ng Ä‘Æ°á»£c Ä‘áº£m báº£o, dáº«n Ä‘áº¿n state khÃ´ng chÃ­nh xÃ¡c.

* **TÃ¹y chá»n `replace` (boolean, tham sá»‘ thá»© hai cá»§a `set`):**
    Máº·c Ä‘á»‹nh, `set` thá»±c hiá»‡n shallow merge (há»£p nháº¥t nÃ´ng). Náº¿u báº¡n muá»‘n thay tháº¿ hoÃ n toÃ n state thay vÃ¬ merge, báº¡n cÃ³ thá»ƒ truyá»n `true` lÃ m tham sá»‘ thá»© hai.

    ```javascript
    set({ count: 100, otherData: 'new value' }, true); // Thay tháº¿ hoÃ n toÃ n state hiá»‡n táº¡i báº±ng object nÃ y
    ```

    **Tháº­n trá»ng khi sá»­ dá»¥ng:** Thay tháº¿ toÃ n bá»™ state cÃ³ thá»ƒ dáº«n Ä‘áº¿n viá»‡c máº¥t cÃ¡c pháº§n state khÃ¡c mÃ  báº¡n khÃ´ng Ä‘á» cáº­p trong object má»›i. Chá»‰ sá»­ dá»¥ng khi báº¡n thá»±c sá»± muá»‘n khá»Ÿi táº¡o láº¡i hoáº·c thay tháº¿ hoÃ n toÃ n state.

### 6.2. `get` Function

`get` Ã­t khi Ä‘Æ°á»£c sá»­ dá»¥ng trá»±c tiáº¿p Ä‘á»ƒ cáº­p nháº­t state, mÃ  chá»§ yáº¿u Ä‘á»ƒ Ä‘á»c giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a state tá»« bÃªn trong má»™t action hoáº·c báº¥t ká»³ logic nÃ o trong store.

**Má»¥c Ä‘Ã­ch:** DÃ¹ng Ä‘á»ƒ Ä‘á»c giÃ¡ trá»‹ hiá»‡n táº¡i cá»§a toÃ n bá»™ state cá»§a store.

**Khi nÃ o sá»­ dá»¥ng `get`:**

* **Äá»c state Ä‘á»ƒ thá»±c hiá»‡n logic phá»©c táº¡p hÆ¡n:** Khi báº¡n cáº§n truy cáº­p má»™t hoáº·c nhiá»u pháº§n cá»§a state Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cÃ¡ch thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng, nhÆ°ng khÃ´ng nháº¥t thiáº¿t pháº£i cáº­p nháº­t chÃ­nh state Ä‘Ã³.

    ```javascript
    // VÃ­ dá»¥: Chá»‰ increment náº¿u count nhá» hÆ¡n má»™t giá»›i háº¡n nÃ o Ä‘Ã³
    incrementIfUnderLimit: () => {
      const currentCount = get().count; // Láº¥y giÃ¡ trá»‹ count hiá»‡n táº¡i
      if (currentCount < 10) {
        set((state) => ({ count: state.count + 1 }));
      } else {
        console.log('Count limit reached!');
      }
    },
    ```

* **Äiá»u kiá»‡n hÃ³a viá»‡c gá»i `set`:** NhÆ° vÃ­ dá»¥ trÃªn, `get` giÃºp báº¡n kiá»ƒm tra Ä‘iá»u kiá»‡n trÆ°á»›c khi thá»±c hiá»‡n má»™t cáº­p nháº­t.

* **TÃ­nh toÃ¡n giÃ¡ trá»‹ má»›i dá»±a trÃªn nhiá»u pháº§n cá»§a state:**

    ```javascript
    // Giáº£ sá»­ cÃ³ thÃªm state: items: []
    addItem: (item) => {
      const currentItems = get().items;
      const newItems = [...currentItems, item];
      set({ items: newItems });
    },
    getTotalItems: () => {
        return get().items.length; // Láº¥y tá»•ng sá»‘ lÆ°á»£ng items
    }
    ```

**LÆ°u Ã½ quan trá»ng vá» `get`:**

* `get()` luÃ´n tráº£ vá» **phiÃªn báº£n hiá»‡n táº¡i nháº¥t cá»§a state**. Äiá»u nÃ y há»¯u Ã­ch khi báº¡n cáº§n Ä‘á»c state sau khi nÃ³ Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t bá»Ÿi má»™t `set` trÆ°á»›c Ä‘Ã³ trong cÃ¹ng má»™t batch.
* Báº¡n **khÃ´ng nÃªn** sá»­ dá»¥ng `get()` Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c side effects (vÃ­ dá»¥: gá»i API) mÃ  thay vÃ o Ä‘Ã³ nÃªn sá»­ dá»¥ng cÃ¡c action hoáº·c middleware.
* Háº§u háº¿t cÃ¡c trÆ°á»ng há»£p cáº­p nháº­t state dá»±a trÃªn state hiá»‡n táº¡i cÃ³ thá»ƒ Ä‘Æ°á»£c giáº£i quyáº¿t tá»‘t hÆ¡n báº±ng cÃ¡ch sá»­ dá»¥ng `set((state) => ({ ... }))` thay vÃ¬ `get()` vÃ  sau Ä‘Ã³ `set()`. Tuy nhiÃªn, `get()` trá»Ÿ nÃªn há»¯u Ã­ch khi báº¡n cáº§n Ä‘á»c má»™t pháº§n cá»§a state mÃ  khÃ´ng pháº£i lÃ  pháº§n báº¡n Ä‘ang cáº­p nháº­t, hoáº·c khi báº¡n cáº§n thá»±c hiá»‡n má»™t sá»‘ logic phá»©c táº¡p trÆ°á»›c khi quyáº¿t Ä‘á»‹nh cáº­p nháº­t.

### So sÃ¡nh `set((state) => ({ ... }))` vÃ  `get()` sau Ä‘Ã³ `set({ ... })`

HÃ£y xem xÃ©t hai cÃ¡ch Ä‘á»ƒ increment count:

**1. CÃ¡ch tá»‘t nháº¥t (sá»­ dá»¥ng hÃ m trong `set`):**

```javascript
increment: () => {
  set((state) => ({ count: state.count + 1 }));
},
```

* **Æ¯u Ä‘iá»ƒm:** Äáº£m báº£o an toÃ n tuyá»‡t Ä‘á»‘i trong mÃ´i trÆ°á»ng báº¥t Ä‘á»“ng bá»™ vÃ  nhiá»u cáº­p nháº­t cÃ¹ng lÃºc. Zustand sáº½ tá»± Ä‘á»™ng "batch" cÃ¡c cáº­p nháº­t vÃ  Ä‘áº£m báº£o `state` trong callback lÃ  phiÃªn báº£n má»›i nháº¥t.

**2. CÃ¡ch sá»­ dá»¥ng `get()` (thÆ°á»ng khÃ´ng cáº§n thiáº¿t cho cáº­p nháº­t Ä‘Æ¡n giáº£n):**

```javascript
incrementUsingGet: () => {
  const currentCount = get().count;
  set({ count: currentCount + 1 });
},
```

* **NhÆ°á»£c Ä‘iá»ƒm (Ä‘á»‘i vá»›i cáº­p nháº­t Ä‘Æ¡n giáº£n):** Máº·c dÃ¹ váº«n hoáº¡t Ä‘á»™ng, nhÆ°ng náº¿u cÃ³ nhiá»u cáº­p nháº­t Ä‘á»“ng thá»i, cÃ³ kháº£ nÄƒng báº¡n sáº½ láº¥y Ä‘Æ°á»£c má»™t `currentCount` khÃ´ng pháº£i lÃ  má»›i nháº¥t trÆ°á»›c khi `set` Ä‘Æ°á»£c thá»±c thi, dáº«n Ä‘áº¿n race condition. Zustand thÆ°á»ng batch cÃ¡c cáº­p nháº­t, nhÆ°ng viá»‡c sá»­ dá»¥ng hÃ m trong `set` lÃ  cÃ¡ch an toÃ n hÆ¡n theo nguyÃªn táº¯c "best practice".
* **Khi nÃ o nÃ³ há»¯u Ã­ch:** NhÆ° Ä‘Ã£ nÃ³i, khi báº¡n cáº§n Ä‘á»c nhiá»u pháº§n cá»§a state hoáº·c thá»±c hiá»‡n logic Ä‘iá»u kiá»‡n phá»©c táº¡p trÆ°á»›c khi cáº­p Ä‘á»‹nh, `get()` ráº¥t há»¯u Ã­ch.

## ğŸ”¥ 7. Async Action trong Zustand

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» cÃ¡ch triá»ƒn khai fetch api trong store cá»§a zustand.

### 7.1 Cáº¥u trÃºc thÆ° má»¥c (Báº¡n táº¡o cÃ¡c file nÃ y)

```
your-project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ userApi.js         <-- File nÃ y
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â””â”€â”€ useUserStore.js    <-- File nÃ y
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ UserProfile.js     <-- File nÃ y
â”‚   â””â”€â”€ App.js                 <-- File nÃ y
â””â”€â”€ package.json               <-- File nÃ y (dÃ¹ng `npm init -y` hoáº·c `yarn init -y`)
```

### 7.2. File `src/api/userApi.js`

File nÃ y chá»©a logic Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i JSONPlaceholder API.

```javascript
// src/api/userApi.js

const BASE_URL = 'https://jsonplaceholder.typicode.com';

/**
 * Fetches user data by ID from JSONPlaceholder.
 * Throws an error if the response is not OK (e.g., 404, 500).
 */
export const fetchUserById = async (userId) => {
  const response = await fetch(`${BASE_URL}/users/${userId}`);

  // Kiá»ƒm tra náº¿u pháº£n há»“i khÃ´ng thÃ nh cÃ´ng (status code 4xx, 5xx)
  if (!response.ok) {
    let errorDetail = 'Unknown error';
    try {
      const errorData = await response.json();
      errorDetail = errorData.message || JSON.stringify(errorData);
    } catch (e) {
      // Bá» qua lá»—i náº¿u body khÃ´ng pháº£i JSON
    }
    throw new Error(`Failed to fetch user (Status: ${response.status} ${response.statusText}): ${errorDetail}`);
  }

  const userData = await response.json();
  return userData;
};

/**
 * Fetches a random user from ID 1 to 10 from JSONPlaceholder.
 * Throws an an error if the response is not OK.
 */
export const fetchRandomUser = async () => {
    // JSONPlaceholder cÃ³ 10 user (ID tá»« 1 Ä‘áº¿n 10)
    const randomId = Math.floor(Math.random() * 10) + 1;
    
    const response = await fetch(`${BASE_URL}/users/${randomId}`);
    
    if (!response.ok) {
        let errorDetail = 'Unknown error';
        try {
            const errorData = await response.json();
            errorDetail = errorData.message || JSON.stringify(errorData);
        } catch (e) {
            // Bá» qua lá»—i náº¿u body khÃ´ng pháº£i JSON
        }
        throw new Error(`Failed to fetch random user (Status: ${response.status} ${response.statusText}): ${errorDetail}`);
    }

    const userData = await response.json();
    return userData;
};
```

---

### 7.3. File `src/store/useUserStore.js`

File nÃ y Ä‘á»‹nh nghÄ©a Zustand store, quáº£n lÃ½ tráº¡ng thÃ¡i ngÆ°á»i dÃ¹ng, tráº¡ng thÃ¡i táº£i vÃ  lá»—i.

```javascript
// src/store/useUserStore.js

import { create } from 'zustand';
import { fetchUserById, fetchRandomUser } from '../api/userApi';

const useUserStore = create((set) => ({
  // --- STATE ---
  /**
   * @type {Object | null} user - Dá»¯ liá»‡u ngÆ°á»i dÃ¹ng hiá»‡n táº¡i Ä‘Æ°á»£c fetch. Null náº¿u chÆ°a cÃ³.
   */
  user: null,
  /**
   * @type {boolean} isLoading - Cá» cho biáº¿t liá»‡u má»™t yÃªu cáº§u API cÃ³ Ä‘ang diá»…n ra hay khÃ´ng.
   */
  isLoading: false,
  /**
   * @type {string | null} error - ThÃ´ng bÃ¡o lá»—i náº¿u cuá»™c gá»i API tháº¥t báº¡i. Null náº¿u khÃ´ng cÃ³ lá»—i.
   */
  error: null,

  // --- ACTIONS ---

  /**
   * Fetches user data by a given ID and updates the store's state.
   * Handles loading and error states.
   * @param {number} userId - The ID of the user to fetch.
   */
  fetchUser: async (userId) => {
    // 1. Báº¯t Ä‘áº§u táº£i: Äáº·t isLoading thÃ nh true vÃ  xÃ³a lá»—i cÅ©
    set({ isLoading: true, error: null });

    try {
      // 2. Thá»±c hiá»‡n cuá»™c gá»i API (sá»­ dá»¥ng await)
      const userData = await fetchUserById(userId);

      // 3. ThÃ nh cÃ´ng: Cáº­p nháº­t dá»¯ liá»‡u ngÆ°á»i dÃ¹ng vÃ  Ä‘áº·t isLoading thÃ nh false
      set({ user: userData, isLoading: false });
    } catch (err) {
      // 4. Tháº¥t báº¡i: Äáº·t lá»—i vÃ  Ä‘áº·t isLoading thÃ nh false
      set({ error: err.message || 'An unexpected error occurred.', isLoading: false });
      console.error("Error fetching user:", err); // Log lá»—i Ä‘á»ƒ debug
    }
  },

  /**
   * Fetches a random user and updates the store's state.
   * Handles loading and error states.
   */
  fetchRandomUser: async () => {
    set({ isLoading: true, error: null });

    try {
      const userData = await fetchRandomUser();
      set({ user: userData, isLoading: false });
    } catch (err) {
      set({ error: err.message || 'An unexpected error occurred.', isLoading: false });
      console.error("Error fetching random user:", err);
    }
  },

  /**
   * Resets the store's user data, loading, and error states to initial values.
   */
  resetUserStore: () => {
    set({ user: null, isLoading: false, error: null });
  },
}));

export default useUserStore;
```

---

### 7.4. File `src/components/UserProfile.js`

Component React nÃ y sáº½ sá»­ dá»¥ng `useUserStore` Ä‘á»ƒ hiá»ƒn thá»‹ thÃ´ng tin ngÆ°á»i dÃ¹ng, tráº¡ng thÃ¡i táº£i vÃ  thÃ´ng bÃ¡o lá»—i.

```javascript
// src/components/UserProfile.js

import React, { useEffect, useState } from 'react';
import useUserStore from '../store/useUserStore';

function UserProfile() {
  // Láº¥y cÃ¡c state vÃ  actions tá»« store
  // CÃ¡ch nÃ y destructure trá»±c tiáº¿p cÃ¡c actions lÃ  tá»‘i Æ°u vÃ  Ä‘Æ°á»£c khuyáº¿n nghá»‹.
  const { user, isLoading, error, fetchUser, fetchRandomUser, resetUserStore } = useUserStore();
  const [userIdInput, setUserIdInput] = useState('');

  // Fetch ngÆ°á»i dÃ¹ng cÃ³ ID 1 khi component Ä‘Æ°á»£c mount láº§n Ä‘áº§u
  // `fetchUser` cÃ³ tham chiáº¿u á»•n Ä‘á»‹nh, nÃªn an toÃ n khi Ä‘á»ƒ trong dependency array
  useEffect(() => {
    fetchUser(1); 
  }, [fetchUser]);

  const handleFetchById = () => {
    const id = parseInt(userIdInput);
    // JSONPlaceholder cÃ³ user ID tá»« 1 Ä‘áº¿n 10
    if (!isNaN(id) && id >= 1 && id <= 10) { 
      fetchUser(id);
    } else {
      alert('Vui lÃ²ng nháº­p User ID há»£p lá»‡ tá»« 1 Ä‘áº¿n 10.');
    }
  };

  return (
    <div style={{ 
      fontFamily: 'Arial, sans-serif', 
      padding: '20px', 
      border: '1px solid #e0e0e0', 
      borderRadius: '10px', 
      maxWidth: '450px', 
      margin: '30px auto', 
      boxShadow: '0 4px 8px rgba(0,0,0,0.1)' 
    }}>
      <h2 style={{ textAlign: 'center', color: '#333' }}>ThÃ´ng tin ngÆ°á»i dÃ¹ng (JSONPlaceholder)</h2>

      {/* Hiá»ƒn thá»‹ tráº¡ng thÃ¡i táº£i */}
      {isLoading && (
        <p style={{ 
          textAlign: 'center', 
          color: '#007bff', 
          fontWeight: 'bold', 
          fontSize: '1.1em' 
        }}>
          Äang táº£i dá»¯ liá»‡u ngÆ°á»i dÃ¹ng...
        </p>
      )}

      {/* Hiá»ƒn thá»‹ lá»—i náº¿u cÃ³ */}
      {error && (
        <p style={{ 
          textAlign: 'center', 
          color: '#dc3545', 
          fontWeight: 'bold', 
          fontSize: '1.1em', 
          backgroundColor: '#f8d7da', 
          padding: '10px', 
          borderRadius: '5px' 
        }}>
          Lá»—i: {error}
        </p>
      )}

      {/* Hiá»ƒn thá»‹ dá»¯ liá»‡u ngÆ°á»i dÃ¹ng náº¿u cÃ³ vÃ  khÃ´ng Ä‘ang táº£i hoáº·c cÃ³ lá»—i */}
      {!isLoading && !error && user && (
        <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '8px', border: '1px solid #e9ecef' }}>
          <h3 style={{ color: '#0056b3', marginBottom: '10px' }}>Chi tiáº¿t ngÆ°á»i dÃ¹ng:</h3>
          <p><strong>ID:</strong> {user.id}</p>
          <p><strong>TÃªn:</strong> {user.name}</p>
          <p><strong>Username:</strong> {user.username}</p>
          <p><strong>Email:</strong> {user.email}</p>
          <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> {user.phone}</p>
          <p><strong>Website:</strong> <a href={`http://${user.website}`} target="_blank" rel="noopener noreferrer">{user.website}</a></p>
        </div>
      )}

      {/* Hiá»ƒn thá»‹ thÃ´ng bÃ¡o náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u */}
      {!isLoading && !error && !user && (
        <p style={{ textAlign: 'center', color: '#6c757d' }}>
          ChÆ°a cÃ³ dá»¯ liá»‡u ngÆ°á»i dÃ¹ng nÃ o Ä‘Æ°á»£c táº£i. HÃ£y thá»­ fetch!
        </p>
      )}

      <hr style={{ margin: '25px 0', borderColor: '#e0e0e0' }} />

      {/* CÃ¡c nÃºt vÃ  input Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c */}
      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
        <div style={{ display: 'flex', gap: '10px' }}>
          <input
            type="text"
            value={userIdInput}
            onChange={(e) => setUserIdInput(e.target.value)}
            placeholder="Nháº­p User ID (1-10)"
            style={{ 
              flexGrow: 1, 
              padding: '10px', 
              borderRadius: '5px', 
              border: '1px solid #ced4da', 
              fontSize: '1em' 
            }}
            disabled={isLoading}
          />
          <button 
            onClick={handleFetchById} 
            disabled={isLoading}
            style={{
              padding: '10px 15px',
              borderRadius: '5px',
              border: 'none',
              backgroundColor: isLoading ? '#a0d9ff' : '#007bff',
              color: 'white',
              cursor: isLoading ? 'not-allowed' : 'pointer',
              fontSize: '1em',
              fontWeight: 'bold',
              transition: 'background-color 0.2s'
            }}
          >
            Fetch theo ID
          </button>
        </div>
        
        <div style={{ display: 'flex', gap: '10px' }}>
          <button 
            onClick={fetchRandomUser} 
            disabled={isLoading}
            style={{
              flexGrow: 1,
              padding: '10px 15px',
              borderRadius: '5px',
              border: 'none',
              backgroundColor: isLoading ? '#a0d9ff' : '#28a745',
              color: 'white',
              cursor: isLoading ? 'not-allowed' : 'pointer',
              fontSize: '1em',
              fontWeight: 'bold',
              transition: 'background-color 0.2s'
            }}
          >
            Fetch ngÆ°á»i dÃ¹ng ngáº«u nhiÃªn
          </button>
          <button 
            onClick={resetUserStore} 
            disabled={isLoading}
            style={{
              flexGrow: 1,
              padding: '10px 15px',
              borderRadius: '5px',
              border: 'none',
              backgroundColor: isLoading ? '#ffb3ba' : '#dc3545',
              color: 'white',
              cursor: isLoading ? 'not-allowed' : 'pointer',
              fontSize: '1em',
              fontWeight: 'bold',
              transition: 'background-color 0.2s'
            }}
          >
            Reset Store
          </button>
        </div>
      </div>
    </div>
  );
}

export default UserProfile;
```

---

### 7.5. File `src/App.js`

File gá»‘c cá»§a á»©ng dá»¥ng Ä‘á»ƒ hiá»ƒn thá»‹ component `UserProfile`.

```javascript
// src/App.js

import React from 'react';
import UserProfile from './components/UserProfile';

function App() {
  return (
    <div className="App">
      <UserProfile />
    </div>
  );
}

export default App;
```

Zustand khÃ´ng chá»‰ máº¡nh máº½ á»Ÿ sá»± Ä‘Æ¡n giáº£n mÃ  cÃ²n cÃ³ thá»ƒ má»Ÿ rá»™ng thÃ´ng qua cÃ¡c **middleware**. NgoÃ i ra, nÃ³ tÃ­ch há»£p tá»‘t vá»›i **DevTools** Ä‘á»ƒ giÃºp báº¡n gá»¡ lá»—i dá»… dÃ ng hÆ¡n.

HÃ£y cÃ¹ng tÃ¬m hiá»ƒu vá» hai tÃ­nh nÄƒng nÃ y vÃ  cÃ¡ch sá»­ dá»¥ng chÃºng.

-----

## 8. TÃ­nh nÄƒng nÃ¢ng cao trong Zustand

### 8.1. Middleware

Middleware trong Zustand lÃ  cÃ¡c hÃ m báº­c cao (higher-order functions) cho phÃ©p báº¡n **thay Ä‘á»•i hoáº·c má»Ÿ rá»™ng hÃ nh vi cá»§a store**. ChÃºng "bá»c" quanh hÃ m `create` vÃ  cÃ³ thá»ƒ thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ nhÆ°:

* Ghi log cÃ¡c thay Ä‘á»•i cá»§a state.
* LÆ°u trá»¯ state vÃ o `localStorage` (persist).
* Chuyá»ƒn Ä‘á»•i cÃ¡c hÃ nh Ä‘á»™ng thÃ nh chuá»—i (serializable) cho DevTools.
* ThÃªm logic phá»¥ trá»£ trÆ°á»›c hoáº·c sau khi state Ä‘Æ°á»£c cáº­p nháº­t.

Zustand cung cáº¥p má»™t sá»‘ middleware tÃ­ch há»£p sáºµn vÃ  báº¡n cÅ©ng cÃ³ thá»ƒ viáº¿t middleware tÃ¹y chá»‰nh.

#### VÃ­ dá»¥ vá» Middleware: `persist`

Middleware `persist` lÃ  má»™t trong nhá»¯ng tÃ­nh nÄƒng há»¯u Ã­ch nháº¥t, cho phÃ©p báº¡n tá»± Ä‘á»™ng lÆ°u trá»¯ state cá»§a store vÃ o `localStorage` (hoáº·c `sessionStorage`, IndexedDB, v.v.) vÃ  khÃ´i phá»¥c nÃ³ khi á»©ng dá»¥ng táº£i láº¡i.

**CÃ i Ä‘áº·t:**
`npm install zustand` (náº¿u chÆ°a cÃ³)

**VÃ­ dá»¥ Minh Há»a:**

```javascript
// src/store/useSettingsStore.js
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

const useSettingsStore = create(
  // Bá»c hÃ m táº¡o store cá»§a báº¡n báº±ng middleware `persist`
  persist(
    (set) => ({
      theme: 'light', // 'light' hoáº·c 'dark'
      notificationsEnabled: true,
      
      toggleTheme: () => set((state) => ({
        theme: state.theme === 'light' ? 'dark' : 'light'
      })),
      toggleNotifications: () => set((state) => ({
        notificationsEnabled: !state.notificationsEnabled
      })),
    }),
    {
      name: 'app-settings', // TÃªn key trong localStorage (hoáº·c storage khÃ¡c)
      storage: createJSONStorage(() => localStorage), // (TÃ¹y chá»n) Chá»‰ Ä‘á»‹nh loáº¡i storage
                                                      // Máº·c Ä‘á»‹nh lÃ  localStorage náº¿u khÃ´ng chá»‰ Ä‘á»‹nh
    }
  )
);

export default useSettingsStore;
```

**CÃ¡ch sá»­ dá»¥ng trong Component:**

```javascript
// src/App.js (hoáº·c báº¥t ká»³ component nÃ o)
import React from 'react';
import useSettingsStore from './store/useSettingsStore';

function App() {
  const { theme, notificationsEnabled, toggleTheme, toggleNotifications } = useSettingsStore();

  return (
    <div style={{ padding: '20px', background: theme === 'dark' ? '#333' : '#f0f0f0', color: theme === 'dark' ? '#eee' : '#333' }}>
      <h1>App Settings</h1>
      <p>Current Theme: <strong>{theme.toUpperCase()}</strong></p>
      <button onClick={toggleTheme} style={{ marginRight: '10px' }}>
        Toggle Theme
      </button>

      <p>Notifications: <strong>{notificationsEnabled ? 'Enabled' : 'Disabled'}</strong></p>
      <button onClick={toggleNotifications}>
        Toggle Notifications
      </button>

      <p style={{ marginTop: '20px', fontSize: '0.9em', fontStyle: 'italic' }}>
        Thá»­ thay Ä‘á»•i cÃ i Ä‘áº·t vÃ  refresh trang. Tráº¡ng thÃ¡i sáº½ Ä‘Æ°á»£c giá»¯ láº¡i!
      </p>
    </div>
  );
}

export default App;
```

**Giáº£i thÃ­ch:**

* Khi báº¡n bá»c `create(...)` báº±ng `persist(...)`, Zustand sáº½ tá»± Ä‘á»™ng:
  * **Táº£i tráº¡ng thÃ¡i:** Khi á»©ng dá»¥ng khá»Ÿi táº¡o, nÃ³ sáº½ kiá»ƒm tra `localStorage` (hoáº·c storage báº¡n chá»‰ Ä‘á»‹nh) vá»›i key `app-settings`. Náº¿u tÃ¬m tháº¥y, nÃ³ sáº½ táº£i dá»¯ liá»‡u Ä‘Ã³ vÃ o store.
  * **LÆ°u tráº¡ng thÃ¡i:** Má»—i khi state cá»§a `useSettingsStore` thay Ä‘á»•i, Zustand sáº½ lÆ°u trá»¯ phiÃªn báº£n má»›i nháº¥t cá»§a state vÃ o `localStorage` dÆ°á»›i key `app-settings`.
* Äiá»u nÃ y giÃºp tráº¡ng thÃ¡i cá»§a báº¡n "bá»n vá»¯ng" qua cÃ¡c láº§n refresh trÃ¬nh duyá»‡t, mang láº¡i tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng liá»n máº¡ch.

-----

## 8.2. DevTools

DevTools (CÃ´ng cá»¥ PhÃ¡t triá»ƒn) lÃ  má»™t tÃ­nh nÄƒng cá»±c ká»³ há»¯u Ã­ch Ä‘á»ƒ **kiá»ƒm tra, theo dÃµi vÃ  gá»¡ lá»—i tráº¡ng thÃ¡i cá»§a á»©ng dá»¥ng**. Zustand tÃ­ch há»£p tá»‘t vá»›i Redux DevTools Extension, má»™t cÃ´ng cá»¥ phá»• biáº¿n trong há»‡ sinh thÃ¡i Redux.

**Lá»£i Ã­ch:**

* **Xem cÃ¡c thay Ä‘á»•i state:** Báº¡n cÃ³ thá»ƒ tháº¥y lá»‹ch sá»­ cá»§a táº¥t cáº£ cÃ¡c thay Ä‘á»•i state vÃ  giÃ¡ trá»‹ state táº¡i má»—i bÆ°á»›c.
* **Time-travel debugging:** Quay ngÆ°á»£c thá»i gian Ä‘á»ƒ xem tráº¡ng thÃ¡i á»©ng dá»¥ng cá»§a báº¡n trÃ´ng nhÆ° tháº¿ nÃ o á»Ÿ cÃ¡c thá»i Ä‘iá»ƒm trÆ°á»›c Ä‘Ã³.
* **Xem actions Ä‘Æ°á»£c dispatch:** Hiá»ƒn thá»‹ cÃ¡c hÃ nh Ä‘á»™ng (actions) Ä‘Ã£ gÃ¢y ra sá»± thay Ä‘á»•i state.
* **Kiá»ƒm tra state hiá»‡n táº¡i:** Xem toÃ n bá»™ tráº¡ng thÃ¡i cá»§a store báº¥t ká»³ lÃºc nÃ o.

**CÃ i Ä‘áº·t:**

1. **CÃ i Ä‘áº·t Redux DevTools Extension:** ÄÃ¢y lÃ  má»™t tiá»‡n Ã­ch má»Ÿ rá»™ng cá»§a trÃ¬nh duyá»‡t (Chrome, Firefox, Edge). Báº¡n cáº§n cÃ i Ä‘áº·t nÃ³ tá»« store cá»§a trÃ¬nh duyá»‡t.

      * [Chrome Web Store - Redux DevTools](https://www.google.com/search?q=https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmjgjmihjigbhpkcndkbklggdggm)
      * [Firefox Browser ADD-ONS - Redux DevTools](https://addons.mozilla.org/en-US/firefox/addon/reduxdevtools/)

2. **CÃ i Ä‘áº·t `zustand/middleware`:**
    `npm install zustand` (náº¿u chÆ°a cÃ³)

**VÃ­ dá»¥ Minh Há»a:**

Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng middleware `devtools` Ä‘á»ƒ kÃ­ch hoáº¡t tÃ­ch há»£p vá»›i Redux DevTools.

```javascript
// src/store/useCounterStore.js
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

const useCounterStore = create(
  // Bá»c hÃ m táº¡o store cá»§a báº¡n báº±ng middleware `devtools`
  devtools(
    (set) => ({
      count: 0,
      
      increment: () => set((state) => ({ count: state.count + 1 }), false, 'increment'), // Tham sá»‘ thá»© 3 lÃ  tÃªn action
      decrement: () => set((state) => ({ count: state.count - 1 }), false, 'decrement'),
      reset: () => set({ count: 0 }, false, 'reset'),
      increaseBy: (amount) => set((state) => ({ count: state.count + amount }), false, `increaseBy (${amount})`),
    }),
    {
      name: 'Counter Store' // TÃªn hiá»ƒn thá»‹ trong DevTools
    }
  )
);

export default useCounterStore;
```

**CÃ¡ch sá»­ dá»¥ng trong Component:**

```javascript
// src/App.js (hoáº·c báº¥t ká»³ component nÃ o)
import React from 'react';
import useCounterStore from './store/useCounterStore';

function App() {
  const { count, increment, decrement, reset, increaseBy } = useCounterStore();

  return (
    <div style={{ padding: '20px', border: '1px solid #ccc', borderRadius: '8px', maxWidth: '400px', margin: '20px auto' }}>
      <h1>Counter App (with DevTools)</h1>
      <p style={{ fontSize: '2.5em', fontWeight: 'bold', textAlign: 'center' }}>{count}</p>
      <div style={{ display: 'flex', justifyContent: 'center', gap: '10px', marginTop: '20px' }}>
        <button onClick={increment}>Increment</button>
        <button onClick={decrement}>Decrement</button>
        <button onClick={reset}>Reset</button>
        <button onClick={() => increaseBy(5)}>Increase By 5</button>
      </div>
      <p style={{ marginTop: '20px', fontSize: '0.9em', fontStyle: 'italic' }}>
        Má»Ÿ Redux DevTools (Ctrl+Shift+I hoáº·c F12 -> tab Redux) Ä‘á»ƒ xem cÃ¡c thay Ä‘á»•i tráº¡ng thÃ¡i.
      </p>
    </div>
  );
}

export default App;
```

**Giáº£i thÃ­ch:**

* Khi báº¡n bá»c `create(...)` báº±ng `devtools(...)`, Zustand sáº½ káº¿t ná»‘i store cá»§a báº¡n vá»›i Redux DevTools Extension.
* **`set(..., false, 'actionName')`**: ÄÃ¢y lÃ  má»™t chi tiáº¿t quan trá»ng. Tham sá»‘ thá»© ba cá»§a hÃ m `set` (`'actionName'`) cho phÃ©p báº¡n Ä‘áº·t tÃªn cho action xuáº¥t hiá»‡n trong DevTools. Náº¿u báº¡n bá» qua tham sá»‘ nÃ y, DevTools sáº½ hiá»ƒn thá»‹ tÃªn máº·c Ä‘á»‹nh nhÆ° `anonymous` hoáº·c `setState`. Viá»‡c Ä‘áº·t tÃªn giÃºp dá»… dÃ ng theo dÃµi hÃ nh Ä‘á»™ng nÃ o Ä‘Ã£ gÃ¢y ra sá»± thay Ä‘á»•i state.
* Sau khi cháº¡y á»©ng dá»¥ng vÃ  thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng (nháº¥n nÃºt), báº¡n má»Ÿ DevTools cá»§a trÃ¬nh duyá»‡t (thÆ°á»ng lÃ  F12 hoáº·c Ctrl+Shift+I), chuyá»ƒn sang tab **Redux**, vÃ  báº¡n sáº½ tháº¥y cÃ¡c thay Ä‘á»•i state cá»§a `Counter Store` cÃ¹ng vá»›i tÃªn action tÆ°Æ¡ng á»©ng.

-----

### 8.3 Káº¿t há»£p nhiá»u Middleware

Báº¡n cÃ³ thá»ƒ káº¿t há»£p nhiá»u middleware báº±ng cÃ¡ch lá»“ng chÃºng vÃ o nhau. Thá»© tá»± bá»c cÅ©ng quan trá»ng vÃ¬ nÃ³ xÃ¡c Ä‘á»‹nh thá»© tá»± thá»±c thi cá»§a middleware.

**VÃ­ dá»¥:** `persist` vÃ  `devtools`

```javascript
// src/store/useCombinedStore.js
import { create } from 'zustand';
import { persist, devtools, createJSONStorage } from 'zustand/middleware';

const useCombinedStore = create(
  // devtools nÃªn bá»c persist Ä‘á»ƒ devtools cÃ³ thá»ƒ tháº¥y toÃ n bá»™ cÃ¡c actions (ká»ƒ cáº£ nhá»¯ng cÃ¡i persist xá»­ lÃ½)
  devtools(
    persist(
      (set) => ({
        // State
        myCount: 0,
        myString: 'hello',

        // Actions
        incrementMyCount: () => set((state) => ({ myCount: state.myCount + 1 }), false, 'incrementMyCount'),
        setMyString: (newString) => set({ myString: newString }, false, 'setMyString'),
      }),
      {
        name: 'Combined Store', // Key cho persist
        storage: createJSONStorage(() => localStorage), // Storage cho persist
      }
    ),
    {
      name: 'Combined Store DevTools' // TÃªn hiá»ƒn thá»‹ trong DevTools
    }
  )
);

export default useCombinedStore;
```

**Thá»© tá»±:** `devtools(persist(...))` thÆ°á»ng lÃ  thá»© tá»± Ä‘Æ°á»£c khuyáº¿n nghá»‹ vÃ¬ nÃ³ cho phÃ©p DevTools quan sÃ¡t cáº£ quÃ¡ trÃ¬nh lÆ°u/táº£i tráº¡ng thÃ¡i cá»§a `persist` middleware.
